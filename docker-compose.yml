version: "3.7"
services:
    ingest:
        container_name: ingest-svc
        restart: unless-stopped
        build:
            context: ./
            dockerfile: redditrepostsleuth/ingestsvc/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.ingesttasks
        entrypoint: python -u ingestsvc.py

    scheduled_task_svc:
        container_name: scheduled_task_svc
        restart: always
        user: "1001:1001"
        build:
            context: .
            dockerfile: redditrepostsleuth/adminsvc/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.admin_tasks,redditrepostsleuth.core.celery.maintenance_tasks
            - C_FORCE_ROOT=True

        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q scheduled_tasks --autoscale=15,2

    scheduler:
        container_name: scheduler
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/adminsvc/Dockerfile
        volumes:
            - /config/repostsleuth-celery:/config/repostsleuth-celery
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.admin_tasks,redditrepostsleuth.core.celery.maintenance_tasks
        entrypoint: celery -A redditrepostsleuth.core.celery beat

    delete_post_svc:
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/delete_post/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - QUERY_LIMIT=1000000
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.admin_tasks

    delete_post_worker:
        container_name: delete-post-worker
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/SummonsWorkerDockerFile
        environment:
            - LOG_LEVEL=DEBUG
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.admin_tasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q post_delete -c 16
        volumes:
            - /opt/imageindex:/opt/imageindex

    stat_monitor_svc:
        container_name: stat_monitor
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/monitorsvc/Dockerfile
        environment:
            - LOG_LEVEL=WARN
        entrypoint: python -u /src/redditrepostsleuth/monitorsvc/monitorsvc.py

    summons_svc:
        container_name: summons-svc
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/summonssvc/Dockerfile
        environment:
            - LOG_LEVEL=DEBUG
        entrypoint: python -u /src/redditrepostsleuth/summonssvc/summonssvc.py

    summons_handler:
        container_name: summons-handler
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/summonssvc/Dockerfile
        environment:
            - LOG_LEVEL=INFO
        entrypoint: python -u /src/redditrepostsleuth/summonssvc/summons_handler_svc_celery.py

    summons_worker:
        container_name: summons-worker
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/SummonsWorkerDockerFile
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.response_tasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q summons -c 3

    submonitor_worker:
        container_name: submonitor-worker
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/SubMonitorWorkerDockerFile
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.response_tasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q submonitor -c 6

    ingest_worker:
        restart: always
        container_name: ingest-worker
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/ingest/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.ingesttasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q post_ingest -c 20

    generic_repost_worker:
        container_name: generic-repost-worker
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/repost/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.reposttasks,redditrepostsleuth.core.celery.ingesttasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q repost,repost_link,watch_notify --autoscale=10,2

    image_repost_worker:
        container_name: image-repost-worker
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/repost/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.reposttasks,redditrepostsleuth.core.celery.ingesttasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q repost_image --autoscale=14,5

    misc_task_worker:
        container_name: misc-task-worker
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/repost/Dockerfile
        environment:
            - LOG_LEVEL=INFO
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.reposttasks,redditrepostsleuth.core.celery.maintenance_tasks,redditrepostsleuth.core.celery.admin_tasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q config_update_check,monitored_sub_config_update,watch_remove_deleted -c 5


    ingest_pushshift_worker:
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/ingest/Dockerfile
        environment:
            - LOG_LEVEL=WARN
            - SLEUTHCONFIG=testconfig.ini
            - C_FORCE_ROOT=True
            - CELERY_IMPORTS=redditrepostsleuth.core.celery.ingesttasks
        entrypoint: celery -A redditrepostsleuth.core.celery worker -Q pushshift -c 4

    pushshift_archive_intake_worker:
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/Dockerfile
        environment:
            - LOG_LEVEL=WARN
            - SLEUTHCONFIG=testconfig.ini
            - C_FORCE_ROOT=True
        entrypoint: celery -A redditrepostsleuth.common worker -Q pushshift_intake -c 1

    pushshift_archive_ingest:
        restart: always
        build:
            context: .
            dockerfile: redditrepostsleuth/workers/Dockerfile
        environment:
            - LOG_LEVEL=WARN
            - SLEUTHCONFIG=testconfig.ini
            - C_FORCE_ROOT=True
        entrypoint: celery -A redditrepostsleuth.common worker -Q pushshift_ingest -c 1

    frontend_api:
        container_name: frontend-api
        build:
            context: .
            dockerfile: redditrepostsleuth/repostsleuthsiteapi/Dockerfile
        environment:
            LOG_LEVEL: INFO
        restart: always
        entrypoint: gunicorn redditrepostsleuth.repostsleuthsiteapi.app --bind 0.0.0.0:7777 --workers 10
        ports:
            - 7777:7777

